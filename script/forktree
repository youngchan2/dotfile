#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

usage() {
  cat << 'EOF'
Usage:
  forktree [--claude] <branch>
  forktree clean
EOF
}

CODER="codex"
if [[ "${1-}" == "--claude" ]]; then
  CODER="claude"
  shift
fi

WORKTREE_HOME="${WORKTREE_HOME:-${HOME}/.worktree}"

if [[ "${1-}" == "clean" ]]; then
  mkdir -p "$WORKTREE_HOME"
  rm -rf -- "$WORKTREE_HOME"/* "$WORKTREE_HOME"/.[!.]* "$WORKTREE_HOME"/..?* 2> /dev/null || true
  exit 0
fi

if [[ $# -ne 1 ]]; then
  usage
  exit 1
fi

BRANCH="$1"
REPO_ROOT="$(git rev-parse --show-toplevel 2> /dev/null)"
if [[ -z "$REPO_ROOT" ]]; then
  echo "Not inside a git repository." >&2
  exit 1
fi

REPO_NAME="$(basename "$REPO_ROOT")"
WORKTREE_PATH="${WORKTREE_HOME}/${REPO_NAME}/${BRANCH}"

mkdir -p "$WORKTREE_PATH"

if git show-ref --verify --quiet "refs/heads/${BRANCH}"; then
  git worktree add "$WORKTREE_PATH" "$BRANCH"
else
  git worktree add -b "$BRANCH" "$WORKTREE_PATH" HEAD
fi

cd "$WORKTREE_PATH"
exec "$CODER"
