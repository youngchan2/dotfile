---
- block:
  - name: Check if nvm is installed
    stat:
      path: "{{ data_home }}/nvm/nvm.sh"
    register: nvm_installed
  - name: Get installed nvm version
    shell: |
      export NVM_DIR="{{ data_home }}/nvm"
      . "$NVM_DIR/nvm.sh"
      nvm --version
    register: nvm_current_version
    changed_when: false
    when: nvm_installed.stat.exists
  - name: Set nvm installation flag
    set_fact:
      nvm_install: "{{ not nvm_installed.stat.exists or nvm_current_version.stdout is version(nvm_version, '<') }}"
  - name: Remove previous nvm installation
    file:
      path: "{{ data_home }}/nvm"
      state: absent
    when: nvm_install
  - name: Clone nvm repository
    git:
      repo: https://github.com/nvm-sh/nvm.git
      dest: "{{ data_home }}/nvm"
      version: "v{{ nvm_version }}"
      depth: 1
    when: nvm_install
  - name: Check if node is installed
    shell: |
      export NVM_DIR="{{ data_home }}/nvm"
      . "$NVM_DIR/nvm.sh"
      nvm which {{ node_version }} 2>/dev/null
    register: node_installed
    changed_when: false
    failed_when: false
  - name: Install node via nvm
    shell: |
      export NVM_DIR="{{ data_home }}/nvm"
      . "$NVM_DIR/nvm.sh"
      nvm install {{ node_version }}
      nvm alias default {{ node_version }}
    when: node_installed.rc != 0
